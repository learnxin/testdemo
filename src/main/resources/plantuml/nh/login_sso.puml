@startuml
autonumber
participant sso
actor user as web
participant product as pd

web -> pd: request
note left of pd:parameter:ssosession \n header: token
    alt ssosession & token= null
        pd->web:json:{redirectUrl:LoginServlet}\n 此Servlet用于发放sso全局标识
        web->sso:redirect
        sso->web:redirect parameter:ssosession(全局标识)
        web->pd:request parameter:ssosession
    else ssosession !=null & token= null
        pd -> sso :check ssosession
            alt 已登录
                pd -> pd:放置redis
                pd -> pd:set header:token(ssosession)\n doFilter
            else 未登录
                pd -> web:json:{redirectUrl:Loginjsp}\n header:token
                web->sso:跳转到登录界面 returnUrl
                sso->sso:已登录
                sso->web:跳转到returnUrl
                web->pd:request
            end
    else ssosession = null  token != null
        pd->pd :check token
        alt token有效
           pd->pd: doFilter
        else token无效
            pd->web:json:{redirectUrl:LoginServlet}\n 此Servlet用于发放sso全局标识
            web->sso:redirect
            sso->web:redirect parameter:ssosession(全局标识)
            web->pd:request parameter:ssosession
        end
    else ssosession & token != null
        alt ssosession = token
            pd -> pd :check token
                alt 校验通过
                    pd->pd: doFilter
                else 不通过
                    pd -> sso :check ssosession
                    alt 校验通过
                        pd -> pd:放置redis
                        pd->pd: doFilter

                    else 不通过

                       pd->web:json:{redirectUrl:LoginServlet}\n 此Servlet用于发放sso全局标识
                    end
                end
        else ssosession != token
            pd -> pd:set header token = ssosession
            pd -> sso :check ssosession
                alt 校验通过
                    pd->pd: doFilter/set redis set header
                else 不通过
                    pd->web:json:{redirectUrl:LoginServlet}\n 此Servlet用于发放sso全局标识
                end
        end
    end
@enduml