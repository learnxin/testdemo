@startuml
title 带有延时触发规则的任务
autonumber
participant "mq" as mq
participant "应用" as app
database "db" as db
participant "下游应用" as oapp
participant "定时任务" as schedule

mq -> app : 拉取消息
app -> app : 转换、补全用户事件信息
app -> db :规则查询
app -> app : 匹配规则
alt 上游事件触发带有延时的规则
    activate app
    app -> app :  生成幂等列
    app -> db :根据幂等列查询event
    alt event存在
    app ->mq :事件已处理
    end
    app -> db :插入event
    app -> db : 根据规则id查询未完成匹配的'触发任务'
    alt '触发任务'不存在
    app ->db : 计算触发时间
    app ->db : 插入任务数据
    app ->mq : 消息已处理
    end
    deactivate app
end


schedule ->db : 查询到达触发时间的任务
loop
    schedule ->db : 查询'触发任务'所有匹配事件
    alt 所有事件均满足
    schedule ->oapp : 发送奖励
    end
    schedule ->db : 更新'触发任务'状态
end

@enduml